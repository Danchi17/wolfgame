<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2Pオンラインワンナイト人狼ゲーム（修正版）</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.3.2/peerjs.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .player {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 10px 0;
            display: flex;
            align-items: center;
        }
        .player-info {
            margin-left: 20px;
        }
        #gameInfo, #actionArea, #actionResult {
            margin-top: 20px;
            font-weight: bold;
        }
        button {
            margin: 5px;
            padding: 5px 10px;
        }
    </style>
</head>
<body>
    <h1>P2Pオンラインワンナイト人狼ゲーム（修正版）</h1>
    <div id="setupArea">
        <input type="text" id="playerName" placeholder="プレイヤー名を入力">
        <button id="createGame">ゲームを作成</button>
        <input type="text" id="gameId" placeholder="ゲームIDを入力">
        <button id="joinGame">ゲームに参加</button>
    </div>
    <div id="gameArea" style="display: none;">
        <div id="playerList"></div>
        <div id="gameInfo"></div>
        <div id="actionArea"></div>
        <div id="actionResult"></div>
        <button id="startGame" style="display: none;">ゲーム開始</button>
        <button id="nextPhase" style="display: none;">次のフェーズへ</button>
        <button id="restartGame" style="display: none;">ゲームをリスタート</button>
    </div>

    <script>
        const peer = new Peer();
        let connections = [];
        let gameState = {
            players: [],
            phase: "待機中",
            roles: ["村人", "村人", "占い師", "怪盗", "人狼", "人狼"],
            assignedRoles: {},
            actions: {},
            graveyard: []
        };
        let currentPlayer = { id: "", name: "", role: "" };
        let isHost = false;

        peer.on('open', (id) => {
            console.log('My peer ID is: ' + id);
        });

        document.getElementById('createGame').addEventListener('click', () => {
            const playerName = document.getElementById('playerName').value;
            if (playerName) {
                isHost = true;
                currentPlayer = { id: peer.id, name: playerName, role: "" };
                gameState.players.push(currentPlayer);
                updateUI();
                alert(`ゲームID: ${peer.id} を他のプレイヤーに共有してください。`);
            }
        });

        document.getElementById('joinGame').addEventListener('click', () => {
            const gameId = document.getElementById('gameId').value;
            const playerName = document.getElementById('playerName').value;
            if (gameId && playerName) {
                currentPlayer = { id: peer.id, name: playerName, role: "" };
                const conn = peer.connect(gameId);
                setupConnection(conn);
            }
        });

        peer.on('connection', (conn) => {
            if (gameState.players.length >= 4) {
                conn.on('open', () => {
                    conn.send({ type: 'gameFull' });
                    conn.close();
                });
                return;
            }
            setupConnection(conn);
        });

        function setupConnection(conn) {
            connections.push(conn);
            conn.on('open', () => {
                conn.on('data', (data) => {
                    handleReceivedData(data, conn);
                });
                if (isHost) {
                    conn.send({ type: 'gameState', state: gameState });
                } else {
                    conn.send({ type: 'playerJoined', player: currentPlayer });
                }
            });
        }

        function handleReceivedData(data, conn) {
            switch (data.type) {
                case 'playerJoined':
                    if (!gameState.players.some(p => p.id === data.player.id) && gameState.players.length < 4) {
                        gameState.players.push(data.player);
                        if (isHost) {
                            sendToAll({ type: 'gameState', state: gameState });
                        }
                    }
                    break;
                case 'gameState':
                    gameState = data.state;
                    currentPlayer.role = gameState.assignedRoles[currentPlayer.id];
                    break;
                case 'startGame':
                    startGame();
                    break;
                case 'nextPhase':
                    nextPhase();
                    break;
                case 'action':
                    handleAction(data.action, data.playerId);
                    break;
                case 'actionResult':
                    showActionResult(data.result);
                    break;
                case 'gameFull':
                    alert('ゲームの定員に達しました。参加できません。');
                    conn.close();
                    return;
                case 'restartGame':
                    restartGame();
                    break;
            }
            updateUI();
        }

        function sendToAll(data) {
            connections.forEach(conn => conn.send(data));
        }

        function updateUI() {
            document.getElementById('setupArea').style.display = 'none';
            document.getElementById('gameArea').style.display = 'block';

            const playerList = document.getElementById('playerList');
            playerList.innerHTML = '';
            gameState.players.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player';
                playerDiv.innerHTML = `
                    <div class="player-info">
                        <h3>${player.name}</h3>
                        <p>役職: ${player.id === currentPlayer.id ? gameState.assignedRoles[player.id] : '?'}</p>
                    </div>
                `;
                playerList.appendChild(playerDiv);
            });

            document.getElementById('gameInfo').textContent = `ゲームフェーズ: ${gameState.phase}`;
            document.getElementById('startGame').style.display = (isHost && gameState.players.length === 4 && gameState.phase === "待機中") ? 'inline' : 'none';
            document.getElementById('nextPhase').style.display = (isHost && gameState.phase !== "待機中" && gameState.phase !== "終了") ? 'inline' : 'none';
            document.getElementById('restartGame').style.display = (isHost && gameState.phase === "終了") ? 'inline' : 'none';

            updateActionArea();
        }

        function updateActionArea() {
            const actionArea = document.getElementById('actionArea');
            actionArea.innerHTML = '';

            if (gameState.phase === currentPlayer.role) {
                switch (currentPlayer.role) {
                    case '占い師':
                        actionArea.innerHTML = `
                            <p>占う対象を選択してください：</p>
                            ${gameState.players.filter(p => p.id !== currentPlayer.id).map(p => 
                                `<button onclick="performAction('seer', '${p.id}')">${p.name}を占う</button>`
                            ).join('')}
                            <button onclick="performAction('seer', 'graveyard')">墓地を見る</button>
                        `;
                        break;
                    case '怪盗':
                        actionArea.innerHTML = `
                            <p>役職を交換する対象を選択してください：</p>
                            ${gameState.players.filter(p => p.id !== currentPlayer.id).map(p => 
                                `<button onclick="performAction('thief', '${p.id}')">${p.name}と交換</button>`
                            ).join('')}
                            <button onclick="performAction('thief', null)">交換しない</button>
                        `;
                        break;
                    case '人狼':
                        const otherWerewolf = gameState.players.find(p => p.id !== currentPlayer.id && gameState.assignedRoles[p.id] === '人狼');
                        if (otherWerewolf) {
                            actionArea.innerHTML = `<p>あなたのチームメイトは${otherWerewolf.name}です。</p>`;
                        } else {
                            actionArea.innerHTML = `<p>あなたは唯一の人狼です。</p>`;
                        }
                        actionArea.innerHTML += `<button onclick="performAction('werewolf', null)">確認しました</button>`;
                        break;
                }
            }
        }

        function performAction(role, target) {
            const action = { role, target };
            gameState.actions[currentPlayer.id] = action;
            if (isHost) {
                handleAction(action, currentPlayer.id);
            } else {
                sendToAll({ type: 'action', action, playerId: currentPlayer.id });
            }
            document.getElementById('actionArea').innerHTML = '<p>アクションを実行しました。</p>';
        }

        function handleAction(action, playerId) {
            let result = '';
            switch (action.role) {
                case 'seer':
                    if (action.target === 'graveyard') {
                        result = `墓地の役職: ${gameState.graveyard[0]}`;
                    } else {
                        const targetRole = gameState.assignedRoles[action.target];
                        result = `${gameState.players.find(p => p.id === action.target).name}の役職: ${targetRole}`;
                    }
                    break;
                case 'thief':
                    if (action.target) {
                        const thiefRole = gameState.assignedRoles[playerId];
                        const targetRole = gameState.assignedRoles[action.target];
                        gameState.assignedRoles[playerId] = targetRole;
                        gameState.assignedRoles[action.target] = thiefRole;
                        result = `あなたの新しい役職: ${targetRole}`;
                    } else {
                        result = 'あなたは役職を交換しませんでした。';
                    }
                    break;
                case 'werewolf':
                    result = 'あなたは人狼の確認を行いました。';
                    break;
            }
            if (isHost) {
                sendToAll({ type: 'gameState', state: gameState });
                connections.find(conn => conn.peer === playerId).send({ type: 'actionResult', result });
            }
        }

        function showActionResult(result) {
            document.getElementById('actionResult').textContent = result;
        }

        document.getElementById('startGame').addEventListener('click', () => {
            if (isHost) {
                sendToAll({ type: 'startGame' });
                startGame();
            }
        });

        function startGame() {
            const shuffledRoles = shuffleArray([...gameState.roles]);
            gameState.players.forEach((player, index) => {
                gameState.assignedRoles[player.id] = shuffledRoles[index];
                if (player.id === currentPlayer.id) {
                    currentPlayer.role = shuffledRoles[index];
                }
            });
            gameState.graveyard = shuffledRoles.slice(4);
            gameState.phase = '占い師';
            gameState.actions = {};
            if (isHost) {
                sendToAll({ type: 'gameState', state: gameState });
            }
            updateUI();
        }

        document.getElementById('nextPhase').addEventListener('click', () => {
            if (isHost) {
                sendToAll({ type: 'nextPhase' });
                nextPhase();
            }
        });

        function nextPhase() {
            const phases = ["待機中", "占い師", "人狼", "怪盗", "昼", "投票", "終了"];
            const currentIndex = phases.indexOf(gameState.phase);
            if (currentIndex < phases.length - 1) {
                gameState.phase = phases[currentIndex + 1];
                if (isHost) {
                    sendToAll({ type: 'gameState', state: gameState });
                }
                updateUI();
            }
        }

        document.getElementById('restartGame').addEventListener('click', () => {
            if (isHost) {
                sendToAll({ type: 'restartGame' });
                restartGame();
            }
        });

        function restartGame() {
            gameState = {
                players: gameState.players,
                phase: "待機中",
                roles: ["村人", "村人", "占い師", "怪盗", "人狼", "人狼"],
                assignedRoles: {},
                actions: {},
                graveyard: []
            };
            currentPlayer.role = "";
            if (isHost) {
                sendToAll({ type: 'gameState', state: gameState });
            }
            updateUI();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
    </script>
</body>
</html>
