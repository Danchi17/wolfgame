<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修正版P2Pオンラインワンナイト人狼ゲーム</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.3.2/peerjs.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .player {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 10px 0;
        }
        #gameInfo, #actionArea, #actionResult {
            margin-top: 20px;
        }
        button {
            margin: 5px;
            padding: 5px 10px;
        }
    </style>
</head>
<body>
    <h1>修正版P2Pオンラインワンナイト人狼ゲーム</h1>
    <div id="setupArea">
        <input type="text" id="playerName" placeholder="プレイヤー名を入力">
        <button id="createGame">ゲームを作成</button>
        <input type="text" id="gameId" placeholder="ゲームIDを入力">
        <button id="joinGame">ゲームに参加</button>
    </div>
    <div id="gameArea" style="display: none;">
        <div id="playerList"></div>
        <div id="gameInfo"></div>
        <div id="actionArea"></div>
        <div id="actionResult"></div>
        <button id="startGame" style="display: none;">ゲーム開始</button>
        <button id="nextPhase" style="display: none;">次のフェーズへ</button>
        <button id="resetGame" style="display: none;">ゲームをリセット</button>
    </div>

    <script>
        const peer = new Peer();
        let connections = [];
        let gameState = {
            players: [],
            phase: "待機中",
            roles: ["村人", "村人", "占い師", "怪盗", "人狼", "人狼"],
            assignedRoles: {},
            graveyard: [],
            actions: {}
        };
        let currentPlayer = { id: "", name: "", role: "" };
        let isHost = false;

        peer.on('open', id => {
            console.log('My peer ID is: ' + id);
        });

        document.getElementById('createGame').addEventListener('click', createGame);
        document.getElementById('joinGame').addEventListener('click', joinGame);
        document.getElementById('startGame').addEventListener('click', startGame);
        document.getElementById('nextPhase').addEventListener('click', nextPhase);
        document.getElementById('resetGame').addEventListener('click', resetGame);

        function createGame() {
            const playerName = document.getElementById('playerName').value;
            if (playerName) {
                currentPlayer = { id: peer.id, name: playerName, role: "" };
                gameState.players.push(currentPlayer);
                isHost = true;
                updateUI();
                alert(`ゲームID: ${peer.id} を他のプレイヤーに共有してください。`);
            }
        }

        function joinGame() {
            const gameId = document.getElementById('gameId').value;
            const playerName = document.getElementById('playerName').value;
            if (gameId && playerName) {
                currentPlayer = { id: peer.id, name: playerName, role: "" };
                const conn = peer.connect(gameId);
                setupConnection(conn);
            }
        }

        peer.on('connection', conn => {
            setupConnection(conn);
        });

        function setupConnection(conn) {
            connections.push(conn);
            conn.on('open', () => {
                conn.on('data', data => {
                    handleReceivedData(data);
                });
                sendToAll({ type: 'playerJoined', player: currentPlayer });
            });
        }

        function handleReceivedData(data) {
            switch (data.type) {
                case 'playerJoined':
                    if (!gameState.players.some(p => p.id === data.player.id)) {
                        gameState.players.push(data.player);
                    }
                    if (isHost) {
                        sendToAll({ type: 'gameState', state: gameState });
                    }
                    break;
                case 'gameState':
                    gameState = data.state;
                    currentPlayer.role = gameState.assignedRoles[currentPlayer.id] || "";
                    break;
                case 'startGame':
                    startGame();
                    break;
                case 'nextPhase':
                    nextPhase();
                    break;
                case 'action':
                    handleAction(data.action, data.playerId);
                    break;
                case 'actionResult':
                    showActionResult(data.result);
                    break;
                case 'resetGame':
                    resetGame();
                    break;
            }
            updateUI();
        }

        function sendToAll(data) {
            connections.forEach(conn => conn.send(data));
        }

        function updateUI() {
            document.getElementById('setupArea').style.display = 'none';
            document.getElementById('gameArea').style.display = 'block';

            const playerList = document.getElementById('playerList');
            playerList.innerHTML = '';
            gameState.players.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player';
                playerDiv.textContent = `${player.name}: ${player.id === currentPlayer.id && gameState.phase !== "占い師" && gameState.phase !== "怪盗" ? currentPlayer.role : '?'}`;
                playerList.appendChild(playerDiv);
            });

            document.getElementById('gameInfo').textContent = `ゲームフェーズ: ${gameState.phase}`;
            document.getElementById('startGame').style.display = (isHost && gameState.players.length === 4 && gameState.phase === "待機中") ? 'inline' : 'none';
            document.getElementById('nextPhase').style.display = (isHost && gameState.phase !== "待機中" && gameState.phase !== "終了") ? 'inline' : 'none';
            document.getElementById('resetGame').style.display = (isHost && gameState.phase === "終了") ? 'inline' : 'none';

            updateActionArea();
        }

        function updateActionArea() {
            const actionArea = document.getElementById('actionArea');
            actionArea.innerHTML = '';

            if (gameState.phase === currentPlayer.role && !gameState.actions[currentPlayer.id]) {
                switch (currentPlayer.role) {
                    case '占い師':
                        actionArea.innerHTML = `
                            <p>誰を占いますか？</p>
                            ${gameState.players.map(player => 
                                player.id !== currentPlayer.id ? 
                                `<button onclick="performAction('seer', '${player.id}')">占う: ${player.name}</button>` : 
                                ''
                            ).join('')}
                            <button onclick="performAction('seer', 'graveyard')">墓地を占う</button>
                        `;
                        break;
                    case '怪盗':
                        actionArea.innerHTML = `
                            <p>誰と役職を交換しますか？</p>
                            ${gameState.players.map(player => 
                                player.id !== currentPlayer.id ? 
                                `<button onclick="performAction('thief', '${player.id}')">交換: ${player.name}</button>` : 
                                ''
                            ).join('')}
                            <button onclick="performAction('thief', null)">交換しない</button>
                        `;
                        break;
                    case '人狼':
                        const otherWerewolf = gameState.players.find(player => 
                            player.id !== currentPlayer.id && gameState.assignedRoles[player.id] === '人狼'
                        );
                        actionArea.innerHTML = otherWerewolf ? 
                            `<p>他の人狼は ${otherWerewolf.name} です。</p>` : 
                            '<p>あなたは唯一の人狼です。</p>';
                        actionArea.innerHTML += `<button onclick="performAction('werewolf', null)">確認</button>`;
                        break;
                }
            }
        }

        function startGame() {
            const allRoles = [...gameState.roles];
            const shuffledRoles = shuffleArray(allRoles);
            gameState.players.forEach((player, index) => {
                gameState.assignedRoles[player.id] = shuffledRoles[index];
                if (player.id === currentPlayer.id) {
                    currentPlayer.role = shuffledRoles[index];
                }
            });
            gameState.graveyard = shuffledRoles.slice(4);
            gameState.phase = '占い師';
            gameState.actions = {};
            sendToAll({ type: 'gameState', state: gameState });
            updateUI();
        }

        function nextPhase() {
            const phases = ["待機中", "占い師", "人狼", "怪盗", "昼", "投票", "終了"];
            const currentIndex = phases.indexOf(gameState.phase);
            if (currentIndex < phases.length - 1) {
                gameState.phase = phases[currentIndex + 1];
                sendToAll({ type: 'gameState', state: gameState });
                updateUI();
            }
        }

        function performAction(role, target) {
            const action = { role, target };
            gameState.actions[currentPlayer.id] = action;
            sendToAll({ type: 'action', action, playerId: currentPlayer.id });
            document.getElementById('actionArea').innerHTML = '<p>アクションを実行しました。</p>';
        }

        function handleAction(action, playerId) {
            let result = '';
            const player = gameState.players.find(p => p.id === playerId);
            switch (action.role) {
                case 'seer':
                    if (action.target === 'graveyard') {
                        result = `墓地の役職: ${gameState.graveyard[0]}`;
                    } else {
                        const targetRole = gameState.assignedRoles[action.target];
                        const targetPlayer = gameState.players.find(p => p.id === action.target);
                        result = `${targetPlayer.name}の役職: ${targetRole}`;
                    }
                    break;
                case 'thief':
                    if (action.target) {
                        const thiefRole = gameState.assignedRoles[playerId];
                        const targetRole = gameState.assignedRoles[action.target];
                        gameState.assignedRoles[playerId] = targetRole;
                        gameState.assignedRoles[action.target] = thiefRole;
                        result = `あなたの新しい役職: ${targetRole}`;
                    } else {
                        result = '役職を交換しませんでした。';
                    }
                    break;
                case 'werewolf':
                    result = '人狼の確認を行いました。';
                    break;
            }
            connections.find(conn => conn.peer === playerId).send({ type: 'actionResult', result });
        }

        function showActionResult(result) {
            document.getElementById('actionResult').textContent = result;
        }

        function resetGame() {
            gameState = {
                players: gameState.players.map(p => ({ ...p, role: "" })),
                phase: "待機中",
                roles: ["村人", "村人", "占い師", "怪盗", "人狼", "人狼"],
                assignedRoles: {},
                graveyard: [],
                actions: {}
            };
            currentPlayer.role = "";
            sendToAll({ type: 'gameState', state: gameState });
            updateUI();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
    </script>
</body>
</html>
