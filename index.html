<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2Pオンラインワンナイト人狼ゲーム（画像・リセット機能付き）</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.3.2/peerjs.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .player {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 10px 0;
            display: flex;
            align-items: center;
        }
        .player-info {
            margin-left: 20px;
        }
        #gameInfo, #actionArea {
            margin-top: 20px;
        }
        button {
            margin: 5px;
            padding: 5px 10px;
        }
        .role-image {
            width: 50px;
            height: 50px;
            object-fit: cover;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <h1>P2Pオンラインワンナイト人狼ゲーム（画像・リセット機能付き）</h1>
    <div id="setupArea">
        <input type="text" id="playerName" placeholder="プレイヤー名を入力">
        <button id="createGame">ゲームを作成</button>
        <input type="text" id="gameId" placeholder="ゲームIDを入力">
        <button id="joinGame">ゲームに参加</button>
    </div>
    <div id="gameArea" style="display: none;">
        <div id="playerList"></div>
        <div id="gameInfo"></div>
        <div id="actionArea"></div>
        <button id="startGame" style="display: none;">ゲーム開始</button>
        <button id="nextPhase" style="display: none;">次のフェーズへ</button>
        <button id="resetGame" style="display: none;">ゲームをリセット</button>
    </div>

    <script>
        const peer = new Peer();
        let connections = [];
        let gameState = {
            players: [],
            phase: "待機中",
            roles: ["村人", "村人", "占い師", "怪盗", "人狼", "人狼"],
            assignedRoles: {},
            graveyard: []
        };
        let currentPlayer = { id: "", name: "", role: "" };
        let isHost = false;

        const roleImages = {
            "村人": "https://example.com/villager.png",
            "占い師": "https://example.com/seer.png",
            "怪盗": "https://example.com/thief.png",
            "人狼": "https://example.com/werewolf.png",
            "unknown": "https://example.com/unknown.png"
        };

        peer.on('open', id => {
            console.log('My peer ID is: ' + id);
        });

        document.getElementById('createGame').addEventListener('click', createGame);
        document.getElementById('joinGame').addEventListener('click', joinGame);
        document.getElementById('startGame').addEventListener('click', startGame);
        document.getElementById('nextPhase').addEventListener('click', nextPhase);
        document.getElementById('resetGame').addEventListener('click', resetGame);

        function createGame() {
            const playerName = document.getElementById('playerName').value;
            if (playerName) {
                currentPlayer = { id: peer.id, name: playerName, role: "" };
                gameState.players.push(currentPlayer);
                isHost = true;
                updateUI();
                alert(`ゲームID: ${peer.id} を他のプレイヤーに共有してください。`);
            }
        }

        function joinGame() {
            const gameId = document.getElementById('gameId').value;
            const playerName = document.getElementById('playerName').value;
            if (gameId && playerName) {
                currentPlayer = { id: peer.id, name: playerName, role: "" };
                const conn = peer.connect(gameId);
                setupConnection(conn);
            }
        }

        peer.on('connection', conn => {
            setupConnection(conn);
        });

        function setupConnection(conn) {
            connections.push(conn);
            conn.on('open', () => {
                conn.on('data', data => {
                    handleReceivedData(data);
                });
                sendToAll({ type: 'playerJoined', player: currentPlayer });
            });
        }

        function handleReceivedData(data) {
            switch (data.type) {
                case 'playerJoined':
                    if (!gameState.players.some(p => p.id === data.player.id)) {
                        gameState.players.push(data.player);
                    }
                    if (isHost) {
                        sendToAll({ type: 'gameState', state: gameState });
                    }
                    break;
                case 'gameState':
                    gameState = data.state;
                    currentPlayer.role = gameState.assignedRoles[currentPlayer.id] || "";
                    break;
                case 'startGame':
                    startGame();
                    break;
                case 'nextPhase':
                    nextPhase();
                    break;
                case 'actionResult':
                    handleActionResult(data.result);
                    break;
                case 'resetGame':
                    resetGame();
                    break;
            }
            updateUI();
        }

        function sendToAll(data) {
            connections.forEach(conn => conn.send(data));
        }

        function updateUI() {
            document.getElementById('setupArea').style.display = 'none';
            document.getElementById('gameArea').style.display = 'block';

            const playerList = document.getElementById('playerList');
            playerList.innerHTML = '';
            gameState.players.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player';
                const roleImage = player.id === currentPlayer.id ? roleImages[currentPlayer.role] : roleImages.unknown;
                playerDiv.innerHTML = `
                    <img src="${roleImage}" alt="${player.id === currentPlayer.id ? currentPlayer.role : 'Unknown'}" class="role-image">
                    <div class="player-info">
                        <h3>${player.name}</h3>
                        <p>役職: ${player.id === currentPlayer.id ? currentPlayer.role : '?'}</p>
                    </div>
                `;
                playerList.appendChild(playerDiv);
            });

            document.getElementById('gameInfo').textContent = `ゲームフェーズ: ${gameState.phase}`;
            document.getElementById('startGame').style.display = (isHost && gameState.players.length === 4 && gameState.phase === "待機中") ? 'inline' : 'none';
            document.getElementById('nextPhase').style.display = (isHost && gameState.phase !== "待機中" && gameState.phase !== "終了") ? 'inline' : 'none';
            document.getElementById('resetGame').style.display = (isHost && gameState.phase === "終了") ? 'inline' : 'none';

            updateActionArea();
        }

        function updateActionArea() {
            const actionArea = document.getElementById('actionArea');
            actionArea.innerHTML = '';

            if (gameState.phase === currentPlayer.role) {
                switch (currentPlayer.role) {
                    case '占い師':
                        actionArea.innerHTML = `
                            <p>誰を占いますか？</p>
                            ${gameState.players.map(player => 
                                player.id !== currentPlayer.id ? 
                                `<button onclick="performSeerAction('${player.id}')">占う: ${player.name}</button>` : 
                                ''
                            ).join('')}
                            <button onclick="performSeerAction('graveyard')">墓地を占う</button>
                        `;
                        break;
                    case '怪盗':
                        actionArea.innerHTML = `
                            <p>誰と役職を交換しますか？</p>
                            ${gameState.players.map(player => 
                                player.id !== currentPlayer.id ? 
                                `<button onclick="performThiefAction('${player.id}')">交換: ${player.name}</button>` : 
                                ''
                            ).join('')}
                        `;
                        break;
                    case '人狼':
                        const otherWerewolf = gameState.players.find(player => 
                            player.id !== currentPlayer.id && gameState.assignedRoles[player.id] === '人狼'
                        );
                        actionArea.innerHTML = otherWerewolf ? 
                            `<p>他の人狼は ${otherWerewolf.name} です。</p>` : 
                            '<p>あなたは唯一の人狼です。</p>';
                        break;
                }
            }
        }

        function startGame() {
            const allRoles = [...gameState.roles];
            const shuffledRoles = shuffleArray(allRoles);
            gameState.players.forEach((player, index) => {
                gameState.assignedRoles[player.id] = shuffledRoles[index];
                if (player.id === currentPlayer.id) {
                    currentPlayer.role = shuffledRoles[index];
                }
            });
            gameState.graveyard = shuffledRoles.slice(4);
            gameState.phase = '占い師';
            sendToAll({ type: 'gameState', state: gameState });
            updateUI();
        }

        function nextPhase() {
            const phases = ["待機中", "占い師", "人狼", "怪盗", "昼", "投票", "終了"];
            const currentIndex = phases.indexOf(gameState.phase);
            if (currentIndex < phases.length - 1) {
                gameState.phase = phases[currentIndex + 1];
                sendToAll({ type: 'gameState', state: gameState });
                updateUI();
            }
        }

        function performSeerAction(target) {
            let result;
            if (target === 'graveyard') {
                result = `墓地の役職: ${gameState.graveyard[0]}, ${gameState.graveyard[1]}`;
            } else {
                const targetPlayer = gameState.players.find(p => p.id === target);
                result = `${targetPlayer.name}の役職: ${gameState.assignedRoles[target]}`;
            }
            alert(result);
            sendToAll({ type: 'actionResult', result: { role: '占い師', action: 'reveal', target, result } });
        }

        function performThiefAction(target) {
            const targetPlayer = gameState.players.find(p => p.id === target);
            const oldRole = currentPlayer.role;
            const newRole = gameState.assignedRoles[target];
            
            gameState.assignedRoles[currentPlayer.id] = newRole;
            gameState.assignedRoles[target] = oldRole;
            currentPlayer.role = newRole;
            
            alert(`あなたの新しい役職は ${newRole} です。`);
            sendToAll({ type: 'actionResult', result: { role: '怪盗', action: 'swap', target, oldRole, newRole } });
            sendToAll({ type: 'gameState', state: gameState });
        }

        function handleActionResult(result) {
            if (isHost) {
                console.log('Action result:', result);
                // ここでゲーム状態を更新する必要がある場合は更新します
            }
        }

        function resetGame() {
            gameState = {
                players: gameState.players.map(p => ({ ...p, role: "" })),
                phase: "待機中",
                roles: ["村人", "村人", "占い師", "怪盗", "人狼", "人狼"],
                assignedRoles: {},
                graveyard: []
            };
            currentPlayer.role = "";
            sendToAll({ type: 'gameState', state: gameState });
            updateUI();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
    </script>
</body>
</html>
